#!/usr/bin/env bash

set -e

if [ "${SW_TASK_DISABLE_DEBUG}" != "1" ]; then
    set -x
fi

ulimit -n 65535 || true

VERBOSE="-vvv"
HANDLER=${SW_RUN_HANDLER:-""}
STEP=${SW_TASK_STEP:-""}
TASK_INDEX=${SW_TASK_INDEX:-0}
TASK_NUM=${SW_TASK_NUM:-0}
RUNTIME_RESTORED=${SW_USER_RUNTIME_RESTORED:-0}


run() {
    if [ "${SW_TASK_DISABLE_DEBUG}" = "1" ]; then
        echo "-->[Preparing] debug config ..."
        VERBOSE="-v"
    fi
    echo "-->[Running] start to run model: ${STEP}, use $(which swcli) cli ..."
    if [ "${RUNTIME_RESTORED}" != "1" ]; then
        runtime_args="--runtime ${SW_RUNTIME_VERSION}"
    else
        runtime_args="--forbid-packaged-runtime"
    fi

    swcli ${VERBOSE} model run --handler=${HANDLER} --step=${STEP} \
        --task-index=${TASK_INDEX} --override-task-num=${TASK_NUM} \
        --uri ${SW_MODEL_VERSION} --version=${SW_JOB_VERSION} \
        --forbid-snapshot \
        ${runtime_args} || exit 1
}

serve() {
    echo "-->[Serving] start to serve, use $(which swcli) cli ..."
    export
    if [ "${RUNTIME_RESTORED}" != "1" ]; then
        swcli ${VERBOSE} model serve --uri "${SW_MODEL_VERSION}" --runtime "${SW_RUNTIME_VERSION}" --host 0.0.0.0 || exit 1
    else
        swcli ${VERBOSE} model serve --uri "${SW_MODEL_VERSION}" --host 0.0.0.0 --forbid-packaged-runtime || exit 1
    fi
}

welcome() {
    echo "===================================="
    echo "StarWhale Docker Entrypoint"
    echo "Date: `date -u +%Y-%m-%dT%H:%M:%SZ`"
    echo "Version: `swcli --version`"
    echo "Run: $1 "
    echo "Model Version: ${SW_MODEL_VERSION}"
    echo "Runtime Version: ${SW_RUNTIME_VERSION}"
    echo "Runtime Restored: ${SW_USER_RUNTIME_RESTORED}"
    echo "Local User: ${SW_USER:-root}"
    echo "===================================="
    if [ ! -z "${SW_USER}" ];
    then
      useradd -g ${SW_USER_GROUP_ID} -u ${SW_USER_ID} ${SW_USER}
      su ${SW_USER}
    fi
}

prepare(){
    if [ "${SW_INSTANCE_URI}" != "local" ]
    then
        # only remote
        echo '-->[Preparing] pulling model ...'
        swcli instance login --token "${SW_TOKEN}" --alias server ${SW_INSTANCE_URI}
        if [ -z "${SW_MODEL_URI}" ]; then
            swcli model copy cloud://server/project/${SW_PROJECT}/model/${SW_MODEL_VERSION} .
        else
            swcli model copy ${SW_MODEL_URI} .
        fi
        if [ "${RUNTIME_RESTORED}" != "1" ]; then
            echo '-->[Preparing] pulling runtime ...'
            if [ -z "${SW_RUNTIME_URI}" ]; then
                swcli runtime copy cloud://server/project/${SW_PROJECT}/runtime/${SW_RUNTIME_VERSION} .
            else
                swcli runtime copy ${SW_RUNTIME_URI} .
            fi
        fi
    fi
    if [ "${RUNTIME_RESTORED}" == "1" ]; then
        # TODO useless?
        $(bash "${SW_USER_RUNTIME_WORKDIR:-/opt/starwhale.user/runtime}"/activate.sw)
    fi
}

install_code_server () {
    if command -v code-server &> /dev/null
    then
        echo "code-server is installed"
    else
        echo "-->[Preparing] install code-server ..."
        curl -fsSL https://code-server.dev/install.sh | sh
        echo "-->[Preparing] install code-server done."
    fi
}

run_code_server () {
    echo "-->[Preparing] run code-server ..."
    PASSWORD=${SW_DEV_TOKEN:=$SW_JOB_VERSION} nohup code-server --bind-addr 0.0.0.0:${SW_DEV_PORT:-8000} --disable-telemetry --disable-update-check --user-data-dir /tmp/code-server-data > /var/log/dev.log 2>&1 &
    echo "-->[Preparing] run code-server done."
}

welcome $1
case "$1" in
    run|evaluation|fine_tune)
        prepare && run
        ;;
    serve|serving)
        prepare && serve
        ;;
    dev)
        prepare && install_code_server && run_code_server
        tail -f /var/log/dev.log
        ;;
    *)
        prepare "starwhale" && exec "$@"
        ;;
esac
